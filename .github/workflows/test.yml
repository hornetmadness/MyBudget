name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.12']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Clear Python cache
      run: |
        find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
        find . -name "*.pyc" -delete 2>/dev/null || true

    - name: Verify Python version
      run: |
        python --version
        pip --version

    - name: Debug - Check Git commit and file contents
      run: |
        echo "=== Git commit info ==="
        git log -1 --oneline
        git log -1 --stat
        echo ""
        echo "=== Checking Budget model relationship ==="
        grep -A 5 "budget_bills.*Relationship" app/models/database.py || echo "Pattern not found"
        echo ""
        echo "=== Checking imports in database.py ==="
        head -30 app/models/database.py

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-httpx

    - name: Debug - Check package versions and model import
      run: |
        echo "=== SQLModel and SQLAlchemy versions ==="
        python -c "import sqlmodel; print(f'SQLModel: {sqlmodel.__version__}')"
        python -c "import sqlalchemy; print(f'SQLAlchemy: {sqlalchemy.__version__}')"
        echo ""
        echo "=== Testing Budget model import ==="
        python -c "
        from app.models.database import Budget, BudgetBill
        import inspect
        print('Budget model imported successfully')
        print('Budget.budget_bills:', Budget.__dict__.get('budget_bills'))
        # Try to get the relationship info
        try:
            from sqlmodel import inspect as sm_inspect
            print('Relationship details:', inspect.getmembers(Budget.budget_bills))
        except Exception as e:
            print(f'Error inspecting relationship: {e}')
        " || echo "Failed to import models"

    - name: Run pytest
      run: |
        pytest --tb=short -v

    - name: Run syntax check
      run: |
        pytest tests/test_syntax.py -v
